name: Gemini Jira Ticket Generator

on:
  repository_dispatch:
    types: [test_gemini]

jobs:
  generate-ticket:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Ticket with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰å€¤ã‚’å–å¾—
          USER_REQUEST: ${{ github.event.client_payload.request }}
          USER_DETAIL: ${{ github.event.client_payload.detail }}
          USER_BACKGROUND: ${{ github.event.client_payload.background }}
          USER_PROBLEM: ${{ github.event.client_payload.problem }}
          USER_BUSINESS_USER: ${{ github.event.client_payload.business_user }}
          USER_GOAL: ${{ github.event.client_payload.goal }}
          USER_OTHER_NOTES: ${{ github.event.client_payload.other_notes }}


        run: |
          # 1. è¦æœ›ã®çµåˆ
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦1ã¤ã®è¦æœ›ã¨ã™ã‚‹
          USER_REQUEST=$(echo -e "Message: $USER_REQUEST\nDetail: $USER_DETAIL\nBackground: $USER_BACKGROUND\nProblem: $USER_PROBLEM\nBusiness User: $USER_BUSINESS_USER\nGoal: $USER_GOAL\nOther Notes: $USER_OTHER_NOTES")

          if [ -z "$USER_REQUEST" ]; then
            echo "Error: client_payload ã« request ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            exit 1
          fi

          # 2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿
          if [ ! -f "templates/ticket_template.md" ]; then
            echo "Error: templates/ticket_template.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            exit 1
          fi
          TICKET_TEMPLATE=$(cat templates/ticket_template.md)
          
          # 3. /src é…ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€ 
          # node_modules ã‚„ .gitã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã‚’é™¤å¤–ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
          echo "Reading source codes from /src..."
          SOURCE_CODES=$(find src -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.html" -o -name "*.css" -o -name "*.java" -o -name "*.go" \) -not -path "*/.*" | while read -r file; do
            echo -e "\n--- File: $file ---"
            cat "$file"
          done)

          if [ -z "$SOURCE_CODES" ]; then
            SOURCE_CODES="srcé…ä¸‹ã«è©²å½“ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi

          # 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          FULL_PROMPT_TEXT=$(cat <<EOS
          ã‚ãªãŸã¯å„ªç§€ãªPMï¼†ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã€è¦æœ›ã€‘ã‚’å…ƒã«ã€Jiraãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          ä»¥ä¸‹ã®ã€è¦æœ›ã€‘ã‚’å…ƒã«ã€Jiraãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          ### æŒ‡ç¤º:
          - ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘ã®é …ç›®ã‚„è¦‹å‡ºã—ã‚’å³å®ˆã™ã‚‹ã“ã¨ã€‚mdå½¢å¼ã§èª­ã¿ã‚„ã™ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã™ã‚‹ã“ã¨ã€‚
          - ã€å‚è€ƒã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã€‘ã‚’è§£æã—ã€ä¿®æ­£ãŒå¿…è¦ãªå…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚„é–¢æ•°åã€ãƒ­ã‚¸ãƒƒã‚¯ã®è¦ç‚¹ã‚’ã€Œå®Ÿè£…å†…å®¹ã€ã«å«ã‚ã¦ãã ã•ã„ã€‚
          - é–‹ç™ºè€…ãŒå³åº§ã«å®Ÿè£…è©³ç´°ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã€å…·ä½“çš„ã‹ã¤ç°¡æ½”ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚

          ### ã€è¦æœ›ã€‘:
          $USER_REQUEST

          ### ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘:
          $TICKET_TEMPLATE

          ### ã€å‚è€ƒã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ/srcï¼‰ã€‘:
          $SOURCE_CODES
          EOS
          )

          # 5. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ (gemini-2.0-flash)
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\":[{\"text\": $(echo "$FULL_PROMPT_TEXT" | jq -aRs .)}]
              }]
            }")

          # 6. æŠ½å‡ºã¨ä¿å­˜
          TICKET_CONTENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          if [ "$TICKET_CONTENT" == "null" ] || [ -z "$TICKET_CONTENT" ]; then
            echo "APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:"
            echo "$RESPONSE"
            exit 1
          fi

          mkdir -p output
          echo "$TICKET_CONTENT" > "output/ticket_$(date +%Y%m%d_%H%M%S).md"
          
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/
          git commit -m "docs: AI generated Jira ticket from dispatch" || echo "No changes to commit"
          git push

      - name: Prepare Jira Content
        run: |
          # ä½œæˆã—ãŸã°ã‹ã‚Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹
          # æœ€æ–°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          LATEST_FILE=$(ls -t output/*.md | head -n 1)
          # Jiraã«é€ã‚‹ç”¨ã«å†…å®¹ã‚’æ•´å½¢ï¼ˆã‚ã¾ã‚Šã«é•·ã„ã¨åˆ¶é™ãŒã‚ã‚‹ã®ã§catã§å¤‰æ•°ã¸ï¼‰
          echo "TICKET_BODY<<EOF" >> $GITHUB_ENV
          cat "$LATEST_FILE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Create Ticket
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: 'PLN99' # ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼
          issuetype: 'Task'
          summary: "ğŸš€ ${{ github.event.client_payload.message }}"
          description: "${{ env.TICKET_BODY }}"

      - name: Log Ticket Link
        run: echo "Jira Ticket Created"